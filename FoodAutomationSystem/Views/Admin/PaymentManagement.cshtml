@model IEnumerable<Transaction>

@{
    ViewData["Title"] = "Payment Management";

    var searchQuery = Context.Request.Query["search"];
    var selectedType = Context.Request.Query["type"];
    var selectedStatus = Context.Request.Query["status"];

    var filtered = Model
        .Where(t =>
            (string.IsNullOrEmpty(searchQuery) ||
                t.User.LastName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                t.Id.ToString().Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
            &&
            (string.IsNullOrEmpty(selectedType) || selectedType == "all" || t.Type == selectedType)
            &&
            (string.IsNullOrEmpty(selectedStatus) || selectedStatus == "all" || t.Status == selectedStatus)
        )
        .ToList();

    var totalRevenue = Model
        .Where(t => t.Type == TransactionType.Reservation && t.Status == TransactionStatus.Success)
        .Sum(t => Math.Abs(t.Amount));

    var totalTopups = Model
        .Where(t => t.Type == TransactionType.WalletTopUp && t.Status == TransactionStatus.Success)
        .Sum(t => t.Amount);

    var failedCount = Model.Count(t => t.Status == TransactionStatus.Failed);
}

<div class="container py-4">

    <!-- Header -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-4 gap-3">
        <div>
            <h2 class="mb-1 fw-bold">Payment Management</h2>
            <p class="text-muted mb-0">Track all transactions and wallet activities</p>
        </div>

        <a class="btn btn-outline-secondary">
            <i class="bi bi-download me-2"></i> Export to Excel
        </a>
    </div>

    <!-- Stats -->
    <div class="row g-4 mb-4">

        <!-- Revenue -->
        <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body">
                    <p class="text-muted mb-1">Total Revenue</p>
                    <h4 class="mb-3">$@(totalRevenue)</h4>
                    <span class="text-success">+12% from last month</span>
                </div>
            </div>
        </div>

        <!-- Topups -->
        <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body">
                    <p class="text-muted mb-1">Wallet Top-ups</p>
                    <h4 class="mb-3">$@totalTopups</h4>
                    <span class="text-primary">+8% from last month</span>
                </div>
            </div>
        </div>

        <!-- Failed -->
        <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body">
                    <p class="text-muted mb-1">Failed Payments</p>
                    <h4 class="mb-3">@failedCount</h4>
                    <span class="text-danger">-2 from last week</span>
                </div>
            </div>
        </div>

        <!-- Success Rate -->
        <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body">
                    <p class="text-muted mb-1">Success Rate</p>
                    <h4 class="mb-3">96.5%</h4>
                    <span class="text-purple">+2% improvement</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <form method="get" class="card shadow-sm border-0 rounded-4 mb-4 p-4">
        <div class="row g-3">

            <!-- Search -->
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-white">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" placeholder="Search..."
                           name="search" value="@searchQuery" />
                </div>
            </div>

            <!-- Type -->
            <div class="col-md-4">
                <select name="type" class="form-select">
                    <option value="all">All Types</option>
                    <option value="reservation">Reservation</option>
                    <option value="wallet_topup">Wallet Top-up</option>
                    <option value="refund">Refund</option>
                </select>
            </div>

            <!-- Status -->
            <div class="col-md-4">
                <select name="status" class="form-select">
                    <option value="all">All Status</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                    <option value="pending">Pending</option>
                </select>
            </div>

        </div>

        <button class="btn btn-primary mt-3">
            Apply Filters
        </button>
    </form>


    <!-- Transactions Table -->
    <div class="card shadow-sm border-0 rounded-4">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Transaction ID</th>
                        <th>Student</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var t in filtered)
                    {
                        <tr>
                            <td>@t.Id</td>

                            <td>
                                <strong>@t.User.LastName</strong><br />
                                <small class="text-muted">@t.UserId</small>
                            </td>

                            <td>
                                @if (t.Type == TransactionType.WalletTopUp)
                                {
                                    <span class="badge bg-primary">Wallet Top-up</span>
                                }
                                else if (t.Type == TransactionType.Reservation)
                                {
                                    <span class="badge bg-purple text-white">Reservation</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Refund</span>
                                }
                            </td>

                            <td>@t.Description</td>

                            <td>@t.Date.ToString("MMM dd, yyyy")</td>

                            <td class="@((t.Type == TransactionType.WalletTopUp) ? "text-success" : "text-danger")">
                                @(t.Type == TransactionType.WalletTopUp ? "+" : "-")$@Math.Abs(t.Amount).ToString("F2")
                            </td>

                            <td>
                                @if (t.Status == TransactionStatus.Success)
                                {
                                    <span class="badge bg-success">Success</span>
                                }
                                else if (t.Status == TransactionStatus.Failed)
                                {
                                    <span class="badge bg-danger">Failed</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <div class="card-footer d-flex justify-content-between">
            <span class="text-muted">Showing @filtered.Count transactions</span>

            <div>
                <button class="btn btn-outline-secondary btn-sm" disabled>Previous</button>
                <button class="btn btn-outline-secondary btn-sm" disabled>Next</button>
            </div>
        </div>
    </div>

</div>
